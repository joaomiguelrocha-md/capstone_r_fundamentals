)
for (pkg in required_packages) {
if (!pkg %in% rownames(installed.packages())) {
install.packages(pkg)
}
library(pkg, character.only = TRUE)
}
remove(required_packages)
remove(pkg)
gdh_base_raw <-  import("data/data_gdh/base_gdh_icd10_no_freg.csv")
code_residence <- import("data/data_gdh/codigos_residencia.csv")
geo_linkage <- import("data/data_gdh/geo_linkage_2024_v6.csv")
comm_pt <- st_read("data/map_json_portugal/concelhos_portugal_light.json")
#
gdh_base_clean <- clean_names(gdh_base_raw)
str(gdh_base_clean)
# code_residence <- code_residence |>
# clean_names() |>
# select(
#   cod_dist,
#   cod_conc,
#   des_dcf
# )
comm_pt <- comm_pt |>
rename(geodsg = NAME_2)
# preparar base dados code_residence e  para join
# code_residence <- code_residence |> # APAGAR NAO E NECESSARIO
#   mutate(
#     across(c(cod_dist, cod_conc), ~sprintf("%02d", .x), .names = "{.col}_chr"),
#     dt_mun = paste0(cod_dist_chr, cod_conc_chr)
#     )
gdh_base_clean <- gdh_base_clean |>
rename(
cod_dist = distrito,
cod_conc = concelho
) |>
mutate(
across(c(cod_dist, cod_conc), ~sprintf("%02d", .x), .names = "{.col}_chr"),
dt_mun = paste0(cod_dist_chr, cod_conc_chr)
)
geo_linkage <- geo_linkage |>
mutate(
dt_mun = str_pad(as.character(dt_mun), 4, pad = 0)
)
geolink_target <- c("dt_mun", "dicofre_2025", "distrito_2013", "municipio_2013", "uls_2024", "nuts2_2024", "nuts2_2024_cod", "nuts3_2024", "nuts3_2024_cod", "regiao_2024")
geo_linkage_target <- geo_linkage |>
select(all_of(geolink_target)) |>
distinct(dt_mun, .keep_all = TRUE)
# residence_geo_join <- geo_linkage_target |>
# left_join(
#   code_residence,
#   geo_linkage_target,
#   by = "dt_mun")
gdh_geo_join <- gdh_base_clean |>
left_join(
geo_linkage_target,
by = "dt_mun")
gdh_uls <- gdh_geo_join |>
filter(uls_2024 %in% c("ULS de Amadora/Sintra", "ULS do Médio Ave"))
# valores únicos
# hosp_id <- distinct(gdh_base, hosp_id)
#
# tipo_adm <- distinct(gdh_base, adm_tip)
#
# patient_id <- distinct(gdh_base, seq_number)
#
# total_patients <- length(patient_id$seq_number)
#
# patient_id <- patient_id |>
#   mutate(
#     age_group = length(patient_id$seq_number)
#   )
# Criar as categorias (ESP 2013)
idade_cat <- idade %>%
mutate(
idade_cat = cut(
valor,
breaks = c(0, 1, 5, 10, 15, 20, 25, 30, 35, 40, 45,
50, 55, 60, 65, 70, 75, 80, 85, 90, 95, Inf),
right = FALSE
)
)
# Criar as categorias (ESP 2013)
gdh_uls <- gdh_uls |>
mutate(
idade_cat = cut(
idade,
breaks = c(0, 1, 5, 10, 15, 20, 25, 30, 35, 40, 45,
50, 55, 60, 65, 70, 75, 80, 85, 90, 95, Inf),
right = FALSE
)
)
# Contar total de observações por grupo etário
contagem_idade <- idade_cat %>%
group_by(idade_cat) %>%
summarise(total = n()) %>%
arrange(idade_cat)
# Contar total de observações por grupo etário
contagem_idade <- gdh_uls %>%
group_by(idade_cat) %>%
summarise(total = n()) %>%
arrange(idade_cat)
View(gdh_uls)
View(contagem_idade)
View(contagem_idade)
# Contar total de observações por grupo etário
contagem_idade <- gdh_uls %>%
group_by(uls_2024, idade_cat) %>%
summarise(total = n()) %>%
arrange(idade_cat)
View(contagem_idade)
# Contar total de observações por grupo etário
contagem_idade <- gdh_uls %>%
group_by(uls_2024, sexo, idade_cat) %>%
summarise(total = n()) %>%
arrange(idade_cat)
View(contagem_idade)
# Contar total de observações por grupo etário
contagem_idade <- gdh_uls %>%
group_by(uls_2024, as.factor(sexo), idade_cat) %>%
summarise(total = n()) %>%
arrange(idade_cat)
View(contagem_idade)
# Visualiza o resultado
print(contagem_idade)
View(gdh_base_clean)
View(contagem_idade)
View(gdh_uls)
# Total Episódios
total_ep_uls <- gdh_uls |>
mutate(
total_episodios = count(seq_number)
)
# Total Episódios
total_ep_uls <- gdh_uls |>
group_by(uls_2024, seq_number) %>%
summarise(total = n()) %>%
arrange(uls_2024)
View(total_ep_uls)
View(gdh_uls)
# Total Episódios
total_ep_uls <- gdh_uls |>
group_by(uls_2024, adm_tip) %>%
summarise(total = n()) %>%
arrange(uls_2024)
View(total_ep_uls)
p4 <- total_ep_uls |>
ggplot(aes(x = adm_tip, y = total)) +
geom_bar() +
facet_wrap(~uls_2024)  # Dividir o gráfico em facetas com base na variável 'tipo_de_especialidade'
p4
p4 <- total_ep_uls |>
ggplot(aes(x = adm_tip, fill = total)) +
geom_bar() +
facet_wrap(~uls_2024)  # Dividir o gráfico em facetas com base na variável 'tipo_de_especialidade'
p4
# Distribuição por sexo ULS
p1 <- gdh_uls |>
ggplot(aes(x = uls_2024, fill = sexo)) +
geom_bar() +
scale_fill_viridis_d(end = .5) +
theme(
# axis.text.y = element_blank(),
# axis.ticks.y = element_blank(),
axis.line.x  = element_blank(),
axis.line.y = element_blank(),
axis.title.x = element_blank(),
axis.title.y = element_blank(),
)
p1
p3 <- gdh_uls |>
count(uls_2024, mortalidade_apr31) |>
mutate(freq = (n / sum(n))) |>
mutate(cum = cumsum(freq)) |>
ggplot(
aes(x = uls_2024, y = freq, fill = mortalidade_apr31)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = .5) +
geom_text(aes(label = freq), position = position_stack(vjust = .95), colour = "white") +
labs(fill = "mortalidade_apr31", y = "Proportion", x = "ULS 2024")
p3
total_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31)
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) %>%
arrange(uls_2024)
View(total_apr31)
total_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31, exclude = NA)
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) %>%
arrange(uls_2024)
View(total_apr31)
total_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31, include = NA)
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) %>%
arrange(uls_2024)
total_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31, NA = "")
View(gdh_uls)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31, exclude = NULL)
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) %>%
arrange(uls_2024)
View(total_mort_apr31)
install.packages("forcats")
library(forcats)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = fct_explicit_na(as.factor(mortalidade_apr31), na_level = “NA”)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = fct_explicit_na(as.factor(mortalidade_apr31), na_level = "NA")
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) %>%
arrange(uls_2024)
required_packages <- c(
"tidyverse",
"rio",
"scales",
"here",
"patchwork",
"sf",
"ggthemes",
"giscoR",
"eurostat",
"sysfonts",
"showtext",
"scales",
"geodata",
"osmdata",
"leaflet",
"janitor",
"assertr",
"data.validator",
"forcats"
)
for (pkg in required_packages) {
if (!pkg %in% rownames(installed.packages())) {
install.packages(pkg)
}
library(pkg, character.only = TRUE)
}
for (pkg in required_packages) {
if (!pkg %in% rownames(installed.packages())) {
install.packages(pkg)
}
library(pkg, character.only = TRUE)
}
remove(required_packages)
remove(pkg)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = fct_explicit_na(as.factor(mortalidade_apr31), na_level = "NA")
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) %>%
arrange(uls_2024)
View(total_mort_apr31)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = fct_explicit_na(as.factor(mortalidade_apr31), na_level = "NA")
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) #%>%
View(total_mort_apr31)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = fct_na_value_to_level(as.factor(mortalidade_apr31), na_level = "NA")
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n()) #%>%
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = ifelse(is.na(mortalidade_apr31), "NA", as.character(mortalidade_apr31)),
mort_cat = factor(mort_cat)
) |>
group_by(uls_2024, mort_cat) %>%
summarise(total = n(), .groups = "drop") %>%
arrange(uls_2024)
View(total_mort_apr31)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = ifelse(is.na(mortalidade_apr31), “NA”, as.character(mortalidade_apr31))
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = ifelse(is.na(mortalidade_apr31), "NA", as.character(mortalidade_apr31))
mort_cat = factor(mort_cat)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = ifelse(is.na(mortalidade_apr31), "NA", as.character(mortalidade_apr31)),
mort_cat = factor(mort_cat)
) |>
group_by(uls_2024, mort_cat) |>
summarise(total = n(), .groups = "drop")  |>
arrange(uls_2024)
View(total_mort_apr31)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = ifelse(is.na(mortalidade_apr31), "NA", as.character(mortalidade_apr31)),
mort_cat = factor(mort_cat)
) |>
group_by(uls_2024, mort_cat) |>
summarise(total = n(), .groups = "drop")  |>
arrange(uls_2024)
View(total_mort_apr31)
p3 <- gdh_uls |>
count(uls_2024, mortalidade_apr31) |>
mutate(freq = (n / sum(n))) |>
mutate(cum = cumsum(freq)) |>
ggplot(
aes(x = uls_2024, y = freq, fill = mortalidade_apr31)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = .5) +
geom_text(aes(label = freq), position = position_stack(vjust = .95), colour = "white") +
labs(fill = "mortalidade_apr31", y = "Proportion", x = "ULS 2024")
p3
mort_cat <- c(unique(gdh_uls$mortalidade_apr31))
mort_cat
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mort_cat, levels = c("NA", sort(unique(mortalidade_apr31!is.na(mortalidade_apr31)))))
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mort_cat, levels = c("NA", sort(unique(mortalidade_apr31[!is.na(mortalidade_apr31)]))))
) |>
group_by(uls_2024, mort_cat) |>
summarise(total = n(), .groups = "drop")  |>
arrange(uls_2024)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31, levels = c("NA", sort(unique(mortalidade_apr31[!is.na(mortalidade_apr31)]))))
) |>
group_by(uls_2024, mort_cat) |>
summarise(total = n(), .groups = "drop")  |>
arrange(uls_2024)
View(total_mort_apr31)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31)
) |>
group_by(uls_2024, mort_cat) |>
summarise(total = n(), .groups = "drop")  |>
arrange(uls_2024)
View(total_mort_apr31)
total_mort_apr31 <- gdh_uls |>
mutate(
mort_cat = factor(mortalidade_apr31)
) |>
group_by(uls_2024, mort_cat) |>
summarise(total = n(), .groups = "drop")  |>
arrange(uls_2024)
View(total_mort_apr31)
View(total_mort_apr31)
p5 <- ggplot(
aes(total_mort_apr31, x = mort_cat, fill = total)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = .5) +
geom_text(aes(label = total), position = position_stack(vjust = .95), colour = "white") +
labs(fill = "Total de episódios", x = "Severidade")
p5 <- total_mort_apr31 |>
ggplot(
aes(x = mort_cat, fill = total)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = .5) +
geom_text(aes(label = total), position = position_stack(vjust = .95), colour = "white") +
labs(fill = "Total de episódios", x = "Severidade")
p5
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = .5) +
geom_text(aes(label = total), position = position_stack(vjust = .95), colour = "white") +
labs(fill = "Total de episódios", x = "Severidade")
p5
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = .5) +
geom_text(aes(label = total), position = position_stack(vjust = .95), colour = "white") +
labs(y = "Total de episódios", x = "ULS", fill = "Severidade")
p5
total_mort_apr31 <- gdh_uls |>
mutate(
mortalidade_apr31 = na_if(mortalidade_apr31, ""),         # transforma "" em NA
mort_cat = fct_explicit_na(factor(mortalidade_apr31), na_level = "NA")
) |>
group_by(uls_2024, mort_cat) |>
summarise(total = n(), .groups = "drop")
View(total_mort_apr31)
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = .5) +
geom_text(aes(label = total), position = position_stack(vjust = .95), colour = "white") +
labs(y = "Total de episódios", x = "ULS", fill = "Severidade")
p5
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 1) +
geom_text(aes(label = total), position = position_stack(vjust = .95), colour = "white") +
labs(y = "Total de episódios", x = "ULS", fill = "Severidade")
p5
p3 <- gdh_uls |>
count(uls_2024, mortalidade_apr31) |>
mutate(freq = (n / sum(n))) |>
mutate(cum = cumsum(freq)) |>
ggplot(
aes(x = uls_2024, y = freq, fill = mortalidade_apr31)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 0) +
geom_text(aes(label = freq), position = position_stack(vjust = .95), colour = "white") +
labs(fill = "mortalidade_apr31", y = "Proportion", x = "ULS 2024")
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 0) +
geom_text(aes(label = total), position = position_stack(vjust = .95), colour = "white") +
labs(y = "Total de episódios", x = "ULS", fill = "Severidade")
p5
# Freq Mortalidade
p3 <- gdh_uls |>
count(uls_2024, mortalidade_apr31) |>
mutate(freq = (n / sum(n))) |>
mutate(cum = cumsum(freq)) |>
ggplot(
aes(x = uls_2024, y = freq, fill = mortalidade_apr31)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 0.5) +
geom_text(aes(label = freq), position = position_stack(vjust = 0), colour = "white") +
labs(fill = "mortalidade_apr31", y = "Proportion", x = "ULS 2024")
p3
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 0.5) +
geom_text(aes(label = total), position = position_stack(vjust = 0), colour = "white") +
labs(y = "Total de episódios", x = "ULS", fill = "Severidade")
p5
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 0.5) +
geom_text(aes(label = total), position = position_stack(vjust = 0.1), colour = "white") +
labs(y = "Total de episódios", x = "ULS", fill = "Severidade")
p5
# Freq Mortalidade
p3 <- gdh_uls |>
count(uls_2024, mortalidade_apr31) |>
mutate(freq = (n / sum(n))) |>
mutate(cum = cumsum(freq)) |>
ggplot(
aes(x = uls_2024, y = freq, fill = mortalidade_apr31)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 0.5) +
geom_text(aes(label = freq), position = position_stack(vjust = 1), colour = "white") +
labs(fill = "mortalidade_apr31", y = "Proportion", x = "ULS 2024")
p3
p5 <- total_mort_apr31 |>
ggplot(
aes(x = uls_2024, y = total, fill = mort_cat)
)+
geom_bar(position = "stack", stat = "identity") +
scale_fill_viridis_d(end = 0.5) +
geom_text(aes(label = total), position = position_stack(vjust = 1), colour = "white") +
labs(y = "Total de episódios", x = "ULS", fill = "Severidade")
p5
residentes_2013 <- import("data/populacao_residente_2013.csv")
View(residentes_2013)
residentes_2013 <- read_delim("data/populacao_residente_2013.csv",
delim = ";",
escape_double = FALSE,
trim_ws = TRUE)
View(residentes_2013)
View(gdh_uls)
View(gdh_base_clean)
View(contagem_idade)
View(comm_pt)
